# 附录 C. 练习答案

本附录包含具有正确答案的练习的答案。开放式练习被省略。

练习2.1

正确答案是 C。 `docker` `logs` 命令查看发送到标准输出的输出。

*练习2.2*

正确的关联是

- Logger —> 结构化记录器的入口点
- Formatter —> 重写遥测数据以适应运输阶段
- Writer —> 将遥测数据传送到 Shipping 阶段

*练习2.3*

正确答案是 B：通过队列或流传送。 Apache Kafka 让流媒体闻名。

*练习3.2*

展望未来并在问题出现之前努力解决问题是可以让你升职的工作。

*练习 4.1*

正确答案是A：日志文件。日志文件是最早创建的遥测类型之一，文件无处不在。现成的软件通常可以选择使用系统记录器，但日志文件是大多数现成的开源软件的首选。

*练习11.1*

几个答案将正确匹配。这是一个：

```
^\[(?<log_level>\w+?)\] (?<action>.+?) to APPID (?<app_id>\d+?), response (?<response_code>\d{3})$
```

请记住， `+?` 表示惰性匹配。观察删除 `?` 字符后步数会发生什么变化。使用正则表达式调试器来观察匹配流在贪婪版本和非贪婪版本之间的变化。

*练习11.3*

多个答案将起作用。这是一个例子

```
Converted type:pdf size:0.192 time:0.89
Signed type:pdf size:0.192 time:1.2
Successful Upload type:pdf size:192 time:0.019
```

匹配正则表达式：

```
^(?<action>.+?) type:(?<file_type>\w{0,6}) size:(?<file_size>[\d.]+?) time:(?<op_time>[\d.]+)$
```

`^(?<action>.*+?)` 表达式匹配“ `type:` ”之前字符串开头的第一个所有内容。 `type:(?<file_type>\w{0,6})` 表达式匹配文件类型，允许包含零到六个字符。 `(?<file_size>[\d.]+?)` 表达式匹配带有一位小数的数字，例如 12.3。

*练习12.1*

有多种方法可以回答这个问题，但其中一个答案的大致内容是

1. 从主文件中删除 `__add_context` 函数（或使其返回空哈希）。
2. 创建一个名为 addcontext.py 的新文件。
3. 在 addcontext.py 中定义一个名为 `AddContext` 的类。
4. 在主文件中，添加 `from addcontext import (AddContext),` ，这会将我们的类（以及上下文添加功能）放回范围内。
5. 在处理器列表中，在最终处理器之前添加 `AddContext` 。

addcontext.py 中的 Python 不必那么复杂，实际上可能主要是从 `__add_context` 函数中删除的代码：

```python
import socket
import os
 
__release__ = "deadbeef"
__commit__  = "abcd1234"
 
class AddContext(object):
 
  def __init__(self):                             ❶
    self.context = {                              ❶
      'hostname': socket.gethostname(),           ❶
      'pid': os.getpid(),                         ❶
      'release': __release__,                     ❶
      'commit': __commit__                        ❶
    }
  
  def __call__(self, logger, name, event_dict):
    return {**event_dict, **self.context}         ❷
```

❶ 在 \_\_init\_\_ 中定义上下文意味着我们只需运行此代码一次。

❷ 返回上下文和已经添加的键的合并哈希

*练习13.1*

正确的关联是

- TCP
  - 面向连接，跟踪连接状态
  - 如果网络故障会重试
  - AQMP、Kafka等应用协议的基础
  - 依赖操作系统来处理重试
- UDP
  - 无连接：即发即忘
  - 在完全私有的内存网络上很有用
  - Syslog 和 SNMP 等服务器协议的基础
  - 依赖应用程序来处理重试

HTTP/3 基于 UDP，并有意将 TCP 概念（例如流量控制、传输窗口大小和重新传输）移至浏览器并远离基本操作系统。

*练习13.2*

正确答案是 D：服务于实用目的的容器，例如集群节点中所有容器的代理、中继或本地服务端点。

A 是直接到标准输出遥测方法的示例，因为容器将日志发送到标准输出并依赖于集群服务器上的某些内容来重新传送。

B 是 sidecar 模式在日志中的使用示例，而不是 sidecar 模式的定义。

C 是传统网络服务的示例，可以存在于 Kubernetes 或服务网格环境之外。

*练习13.3*

正确的约束是

- 云提供商固执己见的存储系统，用于通过标准输出发出遥测数据
- 缺乏系统记录器支持

完全依赖通过标准输出发出遥测数据是不正确的，因为每个云提供商都会捕获标准输出以在其固执己见的存储中显示。

缺乏队列或流支持是不正确的，因为每个云提供商都有一些本地队列可供程序员使用。

云提供商队列中作业的大小限制不是 FaaS 系统的约束；它是对云提供商提供的本机队列的限制。

*练习14.1*

正确答案是 A: `host` 。

- 删除 `host` (A) 会将基数更改为 723,060 (309 * 78 * 15 * 2)。这个环境是 Kubernetes， `host` 在 Kubernetes 环境中很少使用，这使得它成为一个值得丢失的上下文。
- 删除 `pod` (B) 会将基数更改为 139,050 (309 * 19 * 15 * 2)，这非常好。但 `pod` 是 Kubernetes 环境中与上下文相关的遥测的关键部分，因此丢失它也会丢失很多关键上下文。
- 删除 `service` (C) 会将基数更改为 915,876 (309 * 19 * 78 * 2)，但 `service` 会告诉你生成该指标的代码，因此它非常有用。
- 删除 `environment` (D) 会将基数更改为 6,869,070，这高于所需的 1,000,000 阈值。

*练习14.2*

正确答案是

- 磁盘使用量增加——随着索引的增长，包含索引的磁盘也会随之增长。
- 内存使用增加——大多数数据库将索引保存在内存中。随着这些索引的增长，数据库的内存使用量也会增加。此外，某些数据库在维护活动期间会导致内存使用量激增。
- 存储 I/O 增加 - 随着基数增加，数据库必须为每个索引存储更多数据。较大的索引在查询操作期间表现为高 I/O，因为在查询期间管理基数，在维护操作期间管理高 I/O。
- 搜索时间增加——这种症状是基数最明显的后果！
- 摄取率降低——随着索引变得越来越复杂，每个新事件插入数据的开销也会变得更大，从而降低性能。

错误的答案是错误的，因为

- CPU 使用率增加 — 这里的影响很小，与其他影响相比相形见绌。
- 查询率增加——这种影响更多地是由数据库分片（Elasticsearch、Cassandra 和 InfluxDB）造成的，而不是基数增加造成的。
- 减少 CPU 使用 - 如果 CPU 正在等待存储返回索引内容，则这些周期可用于其他查询。

*练习14.3*

正确答案是

- 进程ID——标识特定的执行；度量系统都是关于通用性的。进程 ID 也非常独特，使其成为指标遥测的糟糕选择。
- 帐户 ID - 除非生产系统具有很少的帐户，否则此详细信息将具有太多唯一值，无法使其非常适合指标系统。
- 函数或类名称 - 仅当你在不同位置使用相同的指标名称并且需要消除歧义时，此属性才有用。作为通用键，它具有太多唯一值，无法在度量系统中使用。另一方面，它在集中式日志系统中非常有用！

*练习15.3*

正确答案是

- 生产系统应该使用只写方法来发出。
- 一旦发出，对遥测的所有访问都必须可追踪，并且修改必须显而易见

*练习16.1*

正确答案是 A：工程师将参数记录作为正常记录的一部分。 A 绝对是一次泄漏，而且我不止一次看到这种情况发生，但它不是前两个泄漏之一。

*练习17.1*

正确的关联是

- 集中记录 = 离线档案可快速上线
- 指标 = 聚合
- 分布式追踪=采样
- SIEM = 对存储内容进行高度选择性

*练习17.3*

正确的顺序是

- SIEM
- 指标
- 分布式追踪
- 集中记录