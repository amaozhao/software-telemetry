# 附录 B. 建议清单参考

在本书的 18 章中，我就许多事情提出了许多建议。本附录将这些建议列表整理成一个参考，你可以在改进遥测系统时查找该参考。也许这些清单会对你说服管理层做出你所推动的变革有所帮助。

## B.1 遥测标准、结构和设置策略

这些列表涵盖遥测格式和标准的主题，以及与遥测相关的策略，例如保留和采样策略。

### 第 4.2.2 节：设置标准化遥测格式

第 4.2.2 节介绍了为一家跨国物流公司设置遥测格式标准。这个过程既是政治性的，也是技术性的。在召开标准制定会议时，你应该记住以下几点：

- 目标是让人们使用新的遥测系统。错误的使用通常比不使用要好；错误可以稍后更正。
- 简单是相对于观察者而言的。对你来说很简单的事情对另一个团队来说可能会很复杂；反之亦然。对所有相关人员抱有同理心。
- 对目标和约束的共同理解有助于每个人达成共识。教导、指导，然后引导对话。
- 你可以使用多种遥测运输格式。你希望人们使用这些标准，并且允许多种格式可以降低遥测生产商采用的障碍。

### 第 4.2.4 节：设计遥测格式时考虑基数

第 4.2.4 节是我第一次就遥测中处理基数给出具体建议。该列表主要指向第 14 章，但摘要要点很有用：

- 如果你的流量由单个遥测生成器主导，例如总体事件的一半以上，则当该生成器发出的遥测数据发送到不与其他遥测共享的单独索引时，你的遥测存储系统可能会表现得更好。 （有关此方法的更多信息，请参阅第 14.2.2 节。）高速率系统和其他系统的遥测数据将被有效存储，你将节省金钱和空间。
- 如果你能够在运输阶段修改遥测字段，则采取措施确保不同遥测格式在字段上重叠将提高效率。 （有关此方法的更多信息，请参阅第 14.2.1 节。）许多日志记录格式都有一个 `priority` 字段，因此如果你可以将所有优先级字段放入同一数据类型中，你将节省字段计数。
- 如果你有一个生成大量字段的遥测生成器（可能是因为它以对象编码格式发出），则将该遥测数据发送到单个索引将隔离对该特定生产系统的性能影响。 （参见第 14.2.2 节。）
- 如果你的大型遥测生成系统是你的组织开发的软件，那么花时间与你组织的软件的软件工程团队合作，教他们如何优化遥测系统可以帮助减少现场蔓延。 （第 12 章和第 14.2.1 节详细讨论了这个主题。）

### 第 6.4.1 节：何时何地在集中式日志记录系统中标记或丰富遥测数据

第 6.4.1 节讨论了标记（添加上下文相关的遥测）和丰富（从现有遥测中提取详细信息）如何影响集中式日志记录。集中式日志记录从这两种技术中受益匪浅，因此以下列表更长：

- 如果 Emitting 阶段无法进行上下文相关的标记（请参阅第 6.2.1 节），例如对于硬件系统，则 Shipping 阶段可用于根据记录的字符串提取和丰富遥测数据，如清单 6.4 和 6.5 所示。
- 如果软件正在发送遥测数据，则它具有在发送遥测数据时（即在发送阶段之前或期间）添加上下文相关标记的最佳上下文。标记可以在发射时直接添加到事件中。
- 如果硬件正在发出遥测数据，它通常会在记录的字符串中包含与上下文相关的遥测数据。运输阶段可以提取上下文相关的遥测数据并丰富演示阶段的遥测事件，如第 6.2.2 节中所做的那样。
- 时间戳和其他日期/时间结构对于集中式日志系统正常运行至关重要。运输阶段应将各种日期/时间字符串从其源格式转换为演示阶段系统所需的格式。
- Syslog 的协议故意将年份从时间戳中去掉，因为当一行被发出时，它应该是显而易见的。如果你正在以任何方式处理 Syslog 格式的遥测数据，请考虑在记录的行中添加时间戳（如果可能）或制定如何添加年份的规则。
- 可能需要正则表达式来从字符串中提取有趣的遥测数据——该功能主要由运输阶段完成。
- JSON、YAML 和 XML 等对象编码格式是以字符串形式传送遥测对象的一种方法，并由传送阶段将其转换回对象（丰富）。

### 第 6.4.3 节：何时何地在指标系统中标记或丰富遥测数据

指标系统不像集中式日志系统那样从标记和丰富中受益匪浅。也就是说，由于大多数时间序列数据库的基数敏感性，对指标的标记和丰富的关注点是不同的：

- 发射阶段系统添加与上下文相关的遥测，例如类路径、主机名、程序名称或其他广泛的详细信息，如清单 6.1 所示。
- 运输阶段系统将发出的遥测数据转换为数字并将其传送到指标数据库，如清单 6.7 所示。
- 运输阶段系统可以根据在管道中观察到的遥测数据自行生成指标，例如优先级设置为 `WARN` 的遥测计数。
- 发射器/传送器功能，即第 3.1.1 节中的直接存储模式，在一个地方完成所有这些事情。
- 指标数据库通常对基数有限制，因此在选择与上下文相关的遥测数据时要有选择性。
- 演示系统使用聚合函数来丰富显示的遥测数据，如第 5.1 节中深入介绍的。

### 第 7.2.1 节：寄生负载的寄生程度如何？

第 7.2.1 节中的侧边栏列出了在与生产系统相同的服务器/虚拟机/容器/分区/功能上运行的遥测系统可能产生的寄生负载（从生产操作中夺走资源的负载）的类型。在做出遥测系统决策时，了解以下事项非常重要：

- CPU 成本——如果你对遥测数据所做的唯一事情就是重新发送它，没有其他更改，那么这个区域可能不会很重要。然而，如果你确实执行了更改（可能是第 15 章中确保遥测完整性的技术之一），则此费用可能会很高。在大型硬件实例中，你可能不会注意到这些成本。但在容器或 FaaS 环境中，容器或函数的运行时间增加可能会很明显。
- RAM 成本 - 根据你的运输软件的工作方式，你需要 RAM 来执行更改操作并批量发送下游事件。在大型硬件实例或虚拟机上，此更改可能并不重要。对于计量 RAM 使用情况的容器或 FaaS，这些影响可能会很明显。
- I/O 成本——将一大堆遥测数据写入磁盘会产生 I/O 费用；通过遥测软件读取它也是如此。如果你的存储速度很慢，遥测 I/O 绝对会与生产 I/O 竞争。如果你的存储运行速度较慢，那么将日志放在与生产操作不同的磁盘上会更好。或者，也许你可以重新设计你的遥测系统，以使用第 13 章技术之一并完全避免使用文件。在我的职业生涯中，我见过遥测 I/O 使生产操作生成的 I/O 相形见绌的案例！

### 第 11 章：使正则表达式更快

第 11 章是一份用于加快正则表达式 (regexes) 速度的巨大清单。尽管本章有一个清单（我将在下面介绍），但没有一个总结整个章节。这个新的清单提供了摘要：

- 使正则表达式快速运行的最佳方法是不使用它们。正则表达式的计算成本很高，将它们放入遥测管道中会减慢管道速度。尽可能避免使用它们。
- 最好的正则表达式是能够停止快速尝试匹配的正则表达式。正则表达式引擎会努力在给定字符串中查找匹配项，因此你可以通过告诉正则表达式引擎停止尝试匹配字符串的方式来编写正则表达式，从而提高效率。快速失败以获得更快的性能。
- 如果你要匹配整个字符串，使用锚标记将加快一切速度。 `^` 标记（用于字符串开头）和 `$` 标记（用于字符串结尾）告诉正则表达式引擎从哪里开始尝试匹配。锚点对于让正则表达式引擎停止尝试匹配永远不会匹配的字符串非常有用。
- 你可以通过指定窄字符集和匹配长度来提高速度。如果你知道字符串中的给定字段长度在 4 到 8 个字符之间，则编写正则表达式来指定该长度而不是像 `+` 这样的惰性运算符意味着正则表达式引擎在测试时必须进行更少的比较为了一场比赛。这种方法提高了比赛速度。
- 谨防过度优化；长正则表达式的性能比短表达式差。尽管窄字符集和匹配长度会减少正则表达式引擎尝试的匹配尝试次数，但某些编程语言在使用长而精确的正则表达式时比使用短而通用的正则表达式表现更差。优化表达式时，请始终使用真实数据对其进行测试，以验证你的性能假设。
- 通过花时间将日志语句重写为正则表达式友好，你将获得遥测速度。并非每个组织都可以选择使用结构化记录器。如果你的组织是其中之一，那么花时间重写日志语句以使其能够使用正则表达式进行高效解析将为你带来大量遥测性能。
- 明确指定的正则表达式通常比惰性版本表现更好，但更难以维护。正则表达式对于人类来说并不容易直观地解析，复杂的表达式甚至迫使正则表达式专家停下来弄清楚这些表达式在说什么。这种认知负担减少了愿意维护给定正则表达式的人数。

### 第 11.4 节：优化正则表达式日志语句的项目阶段

第 11.4 节介绍了如何将使用自然语言日志记录语句的程序转变为使用易于正则表达式语法的程序，以提高遥测吞吐量。这是主要项目阶段的列表：

1. 同意一组前置字符串。
2. 与你的团队同意可正则语法。
3. 更新你的遥测系统以处理前置和非前置日志数据。
4. 将每个前置字符串的统一正则表达式添加到遥测系统中。
5. 将现有的日志排放转换为新语法。
6. 转换所有日志发射后，从遥测系统中删除对旧语法的支持。

### 第 12 章：使用结构化记录器的好处

第 12 章是关于结构化日志记录的，该章的介绍包括结构化日志记录的优点列表。如果你需要在项目中转换为结构化记录器，请使用此列表：

- 一套精心编写的标准可以减少你在运输阶段系统中包含正则表达式的需要，这将使你的遥测系统整体更加高效。 （有关正则表达式使用的影响，请参阅第 11 章。）
- 采用结构化日志记录技术（在第 2 章中部分提及，但在第 12.1 节中进行了深入探讨）为你的发射阶段提供了更多关于发送遥测数据的位置并启用多个遥测流的选项。结构化日志发射器允许直接通过 TCP 套接字等新颖通道发送数据，如第 13 章所述。
- 系统地了解日志记录标准为你提供了解决集中式日志记录和指标数据存储中的索引基数问题的工具。第 14 章将深入探讨基数问题的管理。
- 结构化日志格式化程序（第 12.1 节中详细介绍了该主题）是你可以开始使遥测防篡改的地方，从而防止攻击者干预遥测。第 15 章详细探讨了如何使遥测技术能够抵御攻击。
- 通过提供一种系统的方法来添加上下文相关的详细信息（标记）作为发射阶段的一部分，演示阶段中的遥测将更加详细地了解事件发生的时间和方式，从而提高你堵住监管信息泄漏的能力。 （有关数据泄漏后清理的更多信息，请参阅第 16 章。）

### 第 13.1 节：内存中网络及其如何简化遥测

第 13 章是关于非文件发送技术，第 13.1 节是关于使用 TCP 和 UDP 传输进行遥测。当你使用 Kubernetes 或其他容器或虚拟机通过内存网络进行通信的技术时，你可以使用更简单（且更小）的网络技术。使用内存网络有几个优点：

- 你的生产软件将包含更少的专用于遥测系统使用的代码，从而更容易交付。
- 对于微服务，不必使用像 Kafka 这样昂贵（且扩展）的库，可以使可交付的二进制文件小得多。
- 不必支持遥测系统应用程序协议意味着你的生产软件中要包含的模块少了一个——跟踪依赖项的模块少了一个，处理安全漏洞的模块少了一个，以及包含错误的总体代码少了一个。

### 第 14.2.1 节：通过开发过程执行日志记录标准

第 14 章是关于基数的，第 14.2.1 节是关于使用日志记录标准来包含基数问题的。转向新标准是一个政治过程，你可以通过对软件开发实践进行一些更新来轻松过渡：

- 创建强制代码审查步骤，审查所有日志记录语句，以确保它们符合商定的架构。此选项是你的免自动化选项；它依赖于人类记住进行代码审查。但你可以在决定标准后立即进行此审查。
- 更新你的持续集成 (CI) 作业以进行检查，以确保新的日志记录语句仅使用允许列表中的字段。此选项需要为 CI 管道编写自动化，但比信任代码审查和人工更可靠。当包含不允许的字段名称的构建失败时，人们会收到消息。
- 提供新的记录器接口来强制实施架构，并将所有日志记录和指标排放移至新接口。如果你有一个大型代码库，则需要一些时间才能完成所有更改，但此选项是此列表中最长期可维护的选项。

### 第 17.1.3 节：关于设置跟踪保留策略的建议

第 17 章是关于设置遥测的保留、聚合和采样策略。第 17.1 节是关于保留策略的，它有两个清单。这是用于分布式跟踪，它受益于采样：

- 搜索性能是任何遥测系统（包括跟踪）的关键细节。当搜索性能下降时，人们会变得暴躁，而暴躁的人不会获得良好的体验。脾气暴躁的用户表明你需要缩短保留期。
- 离线备份的成本与在线存储的成本一样重要，因此在计算时要考虑这两种成本。

### 第 17.1.4 节：有关设置 SIEM 保留策略的建议

SIEM 系统对其遥测和保留策略有独特的限制：

- 计划以年为单位的保留期。
- 为了控制成本，请在发送到 SIEM 的遥测数据中严格选择。

### 第 17.3 节：选择采样率时的注意事项

分布式跟踪（以及较小程度上的指标）受益于统计采样，作为降低遥测成本的一种方式。选择正确的采样率很棘手，我提供了一系列注意事项：

- 你对流程了解得越多，采样率就越低。如果你理解了它，你就不需要对其进行大量监控。
- 你对流程的了解越少，采样率就越高。你需要通过在多种条件下观察流程来建立信任（和理解）。
- 过程发生的频率越高，采样率就越低。如果你的人口规模很大，你可以采用 0.0001% 等采样率。想象一下，如果 Twitter 试图追踪每一条推文。
- 如果你发现了需要捕获的低频错误，那么短时间内提高采样率将有助于你实时捕获它。
- 生产系统采样率允许与负载测试和持续集成采样率不同。是的，通过对负载测试和预生产环境进行采样，你可以与生产环境进行比较，以了解这些工具是否是有效的测试。
- 100% 的采样率可以让你以最低的成本获得最高质量的数据。

## B.2 演示阶段建议

第 5 章为本书中的每种遥测风格提供了关于良好的演示阶段系统需要具备的一些建议。后面的章节在某些情况下添加了这些建议。它们位于一处，以便于参考。

### 第 5.1.1 节：良好度量系统的特征

指标系统是许多事情的支柱——从 SLO/SLA 合规性审计到查看最新部署是否正常运行。你想要一款好的产品，它具有以下功能：

- 它们允许各种用户创建图表和图形，为任何需要的团队提供决策支持或故障排除。
- 他们提供了用于构建图表和图形背后的查询的指导用户界面，因此用户不必记住查询语法，并且可以轻松构建复杂的查询。
- 他们能够组织图表和图形的集合（通常称为仪表板），以提供团队所需的决策点的概览视图。
- 他们能够组织仪表板，从而轻松找到合适的仪表板。否则，你会得到一大堆难以使用的仪表板。
- 它们允许创建临时仪表板而无需保存，允许用户立即调查某些内容，而不必将仪表板列表与将使用一次的仪表板混淆。

### 第 5.1.1 节：构建仪表板的注意事项

仪表板和图表是指标演示系统的运作方式，因此我为你提供了一些正确操作的技巧。也就是说，有效的可视化是一个广泛的主题，关于如何正确或漂亮地进行可视化，有很多比我更好的工作。构建仪表板时要记住以下三点：

- 请注意暗/亮模式主题如何影响对比度。如果演示系统支持更改背景颜色，请选择颜色，以便具有深色和浅色背景的用户能够看到线条。例如，黄色在黑色上很突出，但在白色上几乎看不见，而深蓝色在白色上显示得很漂亮，但在黑色上却消失了。
- 对于具有多个图表的仪表板，请将最重要的图表放在顶部。人们不喜欢滚动。
- 注意信息密度。如果页面上有太多图表，不熟悉仪表板显示内容的用户将不知道该看什么。

### 第 5.2.1 节：良好的集中式日志系统的特征

集中式日志记录系统在很多方面与 SIEM 系统重叠，但就占用的空间而言仍然是最大的物理遥测系统。当人们诊断生产系统中发生的情况时，集中式日志记录的呈现系统必须支持强大、复杂的搜索。为了有效地履行这些职责，一个好的集中式日志系统应该具备以下能力：

- 按字段内容搜索的能力——我接触过的所有集中式日志系统都具有字段的概念，并允许用户使用这些字段构建查询。使用字段（搜索 `priority:"high"` 与 `"high"` ）内容将大大提高搜索性能。
- 能够支持复杂的搜索逻辑——有时，你所需要的只是一个字符串。在其他时候，获得你需要的东西需要一个复杂的“如果这个，那么那个，除了这些其他的东西，但确实包括这一件事”这样的陈述。
- 自定义字段显示的能力——集中式日志记录系统中的事件可能包括数十个甚至数百个字段，将每个字段显示在一个表格中，该表格通常显示搜索者不关心的信息。自定义结果表以显示特定字段的功能允许搜索者扫描表以查找感兴趣的事件。
- 能够保存搜索和表格布局供以后使用 - 如果你想了解足够的知识来构建搜索和表格布局，那么你很可能会再次需要它。保存布局供以后使用的功能将节省你将来的工作量。
- 能够在用户之间共享已保存的搜索/布局 - 在遥测系统的用户之间共享搜索可以共享分析工具，从而提高组织响应问题的能力，而不是依赖少数熟练的搜索人员来完成工作。
- 能够共享搜索 URL 并显示相同的搜索和布局 - 与共享已保存的搜索相关，在问题响应期间共享即兴搜索或临时搜索至关重要。如果遥测显示系统的 URL 没有重新创建搜索，其他响应者将不得不做更多工作才能看到有趣的结果。一个好的显示系统将减轻这项工作。
- 需要登录才能使用——集中式日志系统通常包含公司敏感信息，有时还包含个人身份信息 (PII) 等受监管信息。绝对最低的要求是在使用显示系统之前要求身份验证和授权。第 15 章详细介绍了这个安全主题。

### 第 5.3 节：将集中式日志记录扩展到 SIEM 工作

SIEM 系统需要超出我在第 5.2.1 节中指定的一些额外功能来支持安全团队的任务：

- 定义警报的能力——集中式日志系统旨在提出你以前可能没有想到过的问题，而 SIEM 系统则作为监控系统的一部分发挥作用。因此，创建警报以通知人们问题的能力是一项关键功能，而在集中式日志系统中，它只是可选的。
- 能够定义警报优先级——按优先级自动对警报进行分类，使响应人员能够安全地延迟较低优先级的警报，从而获得更好的睡眠和更好的工作乐趣。

### 第 7.2.2 节：添加多租户

当你的遥测系统足够大时，你最终需要将遥测隔离到特定组。这种隔离就是多租户。此列表扩展了演示系统所需的功能列表：

- 定义角色的能力——任何访问控制系统的核心都是定义具有权限的角色或组的能力。
- 能够使用单点登录 (SSO) 框架，例如 SAML 和 OpenID Connect (OIDC) - 演示系统可以连接到由技术组织维护的现有身份验证框架。
- 按角色限制对数据源的访问的能力 - 你可以阻止不同角色的成员访问他们不应该访问的数据库，从而减少受监管数据泄漏的清理范围。
- 能够将用户分配给多个角色——用户应该能够担任多个角色，例如需要担任多个团队角色的工程经理。
- 能够按角色限制对仪表板的访问 - 并非每个仪表板都适合系统的每个成员使用，因此限制访问适用于访问仪表板，从而为每个人提供不那么拥挤的体验。
- 能够按角色限制谁可以创建或修改仪表板 - 仅查看用户可以发现现有仪表板非常强大，并且限制编辑访问权限可以减少仪表板蔓延。

## B.3 基数管理

基数是遥测存储最重要的限制之一，这就是为什么我花了第 14 章来讨论它，以及为什么它在本附录中有自己的部分。

### 第 4.2.4 节：设计遥测格式时考虑基数

第 4.2.4 节是我第一次给出处理遥测中基数的具体建议。该列表主要指向第 14 章，但摘要要点很有用。

- 如果你的流量由单个遥测生成器主导，例如总体事件的一半以上，如果该生成器发出的遥测数据被发送到不与其他遥测数据共享的单独索引，那么你的遥测存储系统可能会表现得更好（请参阅第 14.2 节） .2 了解有关此方法的更多信息）。遥测数据将被有效地存储在高速率系统和其他系统中，你将节省金钱和空间。
- 如果你能够在运输阶段修改遥测字段，则采取措施确保不同的遥测格式在字段上重叠将提高一些效率（有关此方法的更多信息，请参阅第 14.2.1 节）。许多日志记录格式都有一个优先级字段，如果你可以将所有优先级字段放入同一数据类型，则可以节省字段计数。
- 如果你有一个生成大量字段的遥测生成器（可能是因为它以对象编码格式发出），则将该遥测发送到单个索引将隔离对该特定生产系统的性能影响（有关更多信息，请参阅第 14.2.2 节） 。
- 如果你的大型遥测生成系统是你的组织开发的软件，那么花时间与你组织的软件的软件工程团队合作，教他们如何优化遥测系统可以帮助减少现场蔓延。第 12 章和第 14.2.1 节详细讨论了这个主题。

### 第14.1节：高基数的症状

虽然不是建议列表，但以下迹象列表告诉你需要采取措施解决遥测系统中的渐进基数问题：

- 搜索性能缓慢——这种症状是大多数人注意到的，因为搜索性能是演示阶段系统的主要特征。不幸的是，除了基数问题之外，许多因素都可能导致搜索缓慢，但性能缓慢是寻找该问题的标志。
- 正常操作的内存使用量增加 - 许多存储系统将索引保存在内存中。随着这些索引的增长，内存使用量也会增加。如果内存不适合这些存储系统，大多数都允许从磁盘读取索引，这会大大降低搜索性能。 MySQL 等关系数据库因这种模式而闻名。
- 例行计划操作的内存使用量增加 - 某些存储系统中的计划优化过程受基数影响。 InfluxDB（从版本 2.0 开始）定期执行压缩操作，与其他时间相比，高基数会导致内存使用量增加（通常增加很多）。
- 插入新数据的能力下降——随着索引变大，它们需要更新。索引效率因存储引擎而异，并非所有存储引擎都擅长。对于某些系统，处理将新值插入到索引中的开销可能会随着唯一值计数的增加而增加，这反过来又会降低将新数据插入到系统中的能力。
- 启动数据库后允许查询的时间增加 - 某些存储系统需要将索引加载到内存中才能进行查询。索引越大，这个过程花费的时间就越长。因为像这样的有状态系统可能不会经常重新启动，所以这个问题可能会在不恰当的时候让你感到惊讶。
- 消耗的磁盘空间的增加超出了摄取速率 - 某些存储系统将索引与表数据保存在单独的文件中。每次插入具有新的唯一值的新数据时，存储系统都需要使用新值更新表数据，并更新所有索引及其文件。在其他系统中，例如 Elasticsearch，每条新数据都会获取所有字段，即使这些字段具有 `null` 值。因此，如果你有 10,000 个字段，并且插入了一个包含 15 个字段的新事件，则该新事件将具有 9,985 个空字段。

### 第 14.2.1 节：健康的低基数上下文相关遥测

上下文相关的遥测（标记）对于告诉人们生产系统中发生的情况非常重要。同时，上下文相关的遥测是基数的主要驱动因素之一。尽管像 Elasticsearch 这样的系统通常可以很好地处理每个字段的许多唯一值，但时间序列数据库却非常敏感。即便如此，一些常见的与上下文相关的遥测选项通常对指标遥测很有帮助：

- 应用程序名称—在运行多个应用程序的生产系统中，存储应用程序名称是相当可行的。总的唯一计数可能很小，并且几乎每个查询都会使用它。
- 应用程序版本 - 当与保留期配对时，版本是一个有趣的概念，因为该字段中的唯一值总数将是保留期内存储的唯一版本的数量。 （有关保留期的更多信息，请参阅第 17 章。）如果你能够承受基数影响，应用程序版本将允许你跟踪指标相对于应用程序版本的变化情况。
- 类名 - 这个概念更多的是一种跟踪概念，但是如果你有一个 `metric_ name` 在多个类中用于多个目的，那么将类名作为一种度量将帮助你将二。在每个指标上放置一个类名是一种反模式，但是因为大多数 `metric_name` 可能不需要这种消歧，并且使用类名会爆炸你的基数。分隔两个相同的 `metric_name` 用途的更好模式是使用不同的 `metric_name` 值（ `class1_pdf_pages` 而不是 `class2_pdf_pages` ）。
- 集群——这个词对于不同的组织有不同的含义，但如果你需要关联错误率或与给定的一组机器/实例/节点等效的东西，集群非常有用。
- 主机名 - 对于某些组织，尤其是在物理硬件上运行的组织，主机名是一组足够小的唯一值，与用于关联行为的 `cluster` 一样有用。对于其他组织，例如在公共云中运行并使用大量自动缩放系统的组织，主机名可以是高度唯一的并且是明显的反模式。
- 数据中心或区域 - 如果你的组织在多个计算设施中运行，则对这些设施进行拆分很有用，特别是因为该值不太可能具有许多唯一值。

### 第 14.2.2 节：分片如何影响基数管理

14.2 节讨论了两种存储端技术，它们对于对抗过多的基数很有用。 14.3.2节讨论了分片，这是分布式数据库的一个常见功能，用于分散读写负载。分片以多种方式影响基数管理，具体取决于你使用的数据存储：

- 如果你使用 MongoDB 进行指标式遥测，则使用时间戳字段作为分片键将平衡服务器之间的读写操作。
- 如果你使用 KairosDB 作为指标，该数据库会为你处理 Cassandra 的分片设置。
- 如果你使用 MongoDB 作为集中式日志系统，使用时间戳作为分片键仍然可以平衡服务器之间的读写。然而，使用复合分片键（例如应用程序加年/月/日）将确保给定日期的所有应用程序写入都将写入同一节点，与真正的均匀写入相比，可能会减少该分片中的基数。
- 如果你使用 Cassandra 或 MongoDB 作为集中式日志系统，则使用应用程序作为分片键在功能上等同于分区（请参阅上一节），但不会给你带来水平扩展的好处。

### 第 14.2.3 节：何时将基数作为别人的问题

第 14.2.3 节介绍了当你决定停止自己管理遥测并付费让其他人通过选择 SaaS 平台来管理遥测时会发生什么。这一选择并不容易做出，而且一切运作方式的这种根本性转变会给你的团队带来混乱。当你计划向管理层推销以改变你的做法时，我提供了一系列需要考虑的挑战：

- 维护当前系统的员工成本通常很难用货币价值来衡量，这使得比较 SaaS 选项的成本变得更加困难。当你计算外部解决方案的成本时，这些隐性成本会感觉更大，直到你将隐性人员成本添加到当前解决方案中。
- 当前系统中涉及的硬件或云提供商资源的成本与其余基础设施成本一起摊销，因此这些成本感觉是隐藏的。与人员成本一样，如果你不考虑当前系统的托管成本，你将无法与外部解决方案的成本进行真正的比较。
- 从开源工具转向按月付费的提供商感觉就像是放弃。这种反应是一种情绪反应（做出决定的人类是情绪动物；忽视这一事实后果自负），但它对决策的阻碍并不亚于成本。关注理性成本和商业价值，克服情绪反应。

## B.4 遥测安全性和影响

遥测安全既包括保护其免受试图隐藏其踪迹的攻击者的攻击，也包括防止受监管数据的泄露，例如与财务、隐私和健康相关的数据（我称之为有毒数据）。第 15 章和第 16 章涵盖了这两个主题，并提供了关于这两个主题的许多推荐列表。

### 第15章：安全遥测的两个原则

第 15 章介绍如何保护遥测系统免受内部和外部攻击。在规划防御时，你需要遵循两大原则：

- 生产系统应使用只写方法发出遥测数据。如果生产系统可以读取它们所写的内容，或者更糟糕的是，删除它们所写的内容，那么你就有一个漏洞。第 15.1 节介绍了使只写遥测成为现实的方法。
- 一旦发出，所有对遥测的访问（包括操作员/root/管理员访问）都必须可追踪，并且修改必须显而易见。此方法可确保已发出的遥测数据仍然是生产系统中发生的情况的真实记录，并使以后的篡改变得明显。 15.2 节介绍了这些方法。

### 第 15.1.1 节：遥测移动速度太快而无法捕捉

我在第 15.1.1 节中讨论的防御技术是将遥测技术从生产服务器/虚拟机/实例/容器/分区中移出的速度比攻击者更改它的速度要快。我为这个过程给出了两个设计目标：

- 遥测数据需要持续发送。某些遥测系统依赖 Cron 或 Windows Scheduler 任务将日志文件从服务器复制到中央 NFS 或共享驱动器。发出遥测数据和日志文件离开盒子之间的长延迟对于攻击者来说是一个巨大的窗口。
- 遥测在发射发生和发送到运输阶段的其余部分之间需要有较短的延迟。低延迟进一步减少了攻击者修改遥测数据的窗口。持续运送是不够的；你最近也需要发货。如果遥测完整性对你的组织非常重要，则需要针对过度的运输滞后创建警报。

### 15.2.1节：三个Linux强制访问控制系统

15.2.1 节讨论了使用访问控制系统创建只写位置来放置日志文件。 Windows 很简单，但 Linux 有一组复杂的选项用于创建只写目录。我提供了 Linux 可用的三个强制 ACL 系统的列表，以及关于更好地使用它们的建议：

- POSIX ACL - 默认 ACL 系统的此扩展允许对目录或文件执行类似于 Windows 的多个权限规范。但是，它需要文件系统支持以及特定的安装选项来启用它，因为重新安装是一个简单的操作，并且你可以使用不同的参数重新安装，因此从卷中删除 POSIX ACL 支持很容易。由于 ACL 强制可以很容易地关闭，因此大多数安全团队并不认为 POSIX ACL 真正可行。
- SELinux — 安全增强型 Linux 是编译到 Linux 内核中的强制访问控制 (MAC) 系统。与 POSIX ACL 不同，SELinux 可以在任何地方强制执行。 SELinux 的工作原理是为每个文件、对象、进程和其他一切提供一个标签，并定义每个标签如何与其他标签交互。此设置允许定义关系，例如允许 exampleapp 访问由logging_platform 创建的套接字，而无需指定文件级权限。 Red Hat 和 SLES 开箱即用地支持 SELinux。
- AppArmor——这个MAC系统也被编译到Linux内核中。它是在 SELinux 之后开发的，旨在提供 SELinux 的大部分优点，但管理接口的方法要简单得多。当进程启动时，它们会被分配一个 AppArmor 配置文件。由于 UNIX 理念是将所有内容视为文件，因此 AppArmor 配置文件定义每个配置文件可以访问哪些文件以及允许配置文件对这些文件执行哪些操作。 Ubuntu 和 SLES 开箱即用地支持 AppArmor。

### 第 15.2.1 节：在遥测管道中使用 ACL 的位置

第 15.2 节检查了运输阶段以及内部攻击者可以利用来修改遥测的区域。其中涉及两个指导原则：

- 如果可能的话，所有系统都必须支持身份验证，并配置为需要它。
- 还必须跟踪显示这些身份验证尝试的日志（并且可能会分叉到安全团队的 SIEM 系统中）。

### 第 15.2.3 节：加密和数字签名如何支持遥测

本节有两个推荐列表。第一个列表定义了数字签名（一种验证某些内容未被篡改的方法）如何帮助实现遥测的目标：

- 当你进行安全调查时，使用散列字段可以更轻松地检测被篡改的事件。
- 由于运输阶段的工作是修改遥测（请参阅第 3、4 和 6 章），因此它处于验证来自生产系统（或另一个运输阶段组件）的哈希值和实时警报的主要位置如果它捕获到哈希失败。

第二个列表扩展了第一个列表，以解决遥测管道中加密的作用：

- 将最初发出的遥测数据与未加密的遥测数据并排加密，可以为安全事件响应者提供有关遥测数据已更改的内容的提示。
- 加密提供了一种更安全的方式来处理有毒信息，例如隐私和健康相关信息。
- 与散列（参见上一小节）相比，数字签名遥测数据可以更强有力地保证遥测数据最后是由受信任方修改的。
- 数字签名通过使更改防篡改来提供散列的所有优点。

### 第 15.2.3 节：加密和数字签名如何使遥测变得更加脆弱

加密是证明遥测数据未被篡改的最佳方法，但它也会使你的遥测数据更加脆弱——这是你必须做出的权衡。如果你想在遥测中添加加密或数字签名，请在开始项目之前考虑以下痛点：

- 如果结构化记录器的编写者默默地重新编码字符串（例如将 ASCII 编码为 UTF-8），则格式化程序创建的任何数字签名都将被破坏。确保结构化记录器的格式化程序和编写器组件在字符串编码方面非常清晰。
- 如果你的队列、流或其他遥测传输方法默默地重新编码字符串，则任何数字签名都将被破坏。确保你构建的系统能够处理这些字符串转换。
- 如果你的存储系统默默地重新编码字符串或更改浮点数的精度，则最后一个数字签名将被破坏。
- 密钥过期会破坏你的遥测系统，就像忘记更新网站上的 SSL 证书会破坏你的网站一样。为了避免这种中断，你需要创建一个系统来安全地更新签名/加密密钥。此外，你需要将密钥更新传达给验证阶段，以便他们知道会发生更改。使用链接到证书颁发机构的公钥加密技术将有所帮助，但会将问题转移到过期的证书颁发机构。
- 私钥和公钥分发的任何失败都将导致至少部分遥测中断。将此失败案例构建到你的服务产品中（修改你的服务级别协议，以使用 SRE 术语），以便你的遥测用户更好地了解你的可用性承诺。

### 第 16.1 节：三种类型的有毒数据

有毒数据是受规定安全处理程序法规约束的数据，如果不正确执行这些程序，则会受到处罚。如果你的生产系统处理有毒数据，你的遥测系统也可能会无意中包含它。以下是有毒数据的最大类别：

- 金融信息——几十年来，金融机构及其监管机构一直将第一种有毒数据视为此类数据，尽管支付卡行业需要在银行之外提供和执行处理标准。该标准称为支付卡行业数据安全标准（PCI/DSS）。
- 健康信息——第二种获得广泛接受的有毒数据，健康记录的计算机化（以及由此带来的共享便利性）推动了健康隐私监管，例如美国健康保险流通与责任法案（HIPAA）。该信息也称为 ePHI（电子受保护健康信息）。
- 个人身份信息 (PII)——PII 是第三种获得认可的有毒数据。欧盟的 GDPR 是第一个全面的法规，并在世界各地的州、省和国家启动了一系列其他法规。

### 第 16.1 节：对有毒数据处理不当的处罚

错误处理有毒数据将使你的组织面临法律风险。影响是可变的，但我提供了可能的处罚清单。使用此列表来吓唬人们，让他们认真对待这一威胁：

- 在一段时间内拒绝处理此类信息 — 如果严重违反 PCI/DSS，支付卡行业将禁止你处理信用卡和借记卡。这种处罚使几乎所有年轻公司破产或将它们转移到只接受直接银行转账和加密货币的利基市场。
- 巨额罚款——监管机构知道企业了解金钱，因此他们会让违规行为造成经济损失。更糟糕的是，此类罚款通常会公开，因此该组织的声誉也会受到重大打击。
- 公开承认发生了违规行为——强制披露法强制违规组织通知受影响的人或公开披露发生了违规行为。没有一家公司喜欢承认错误，这就是为什么监管机构强制采取这一步骤，以此来牢记“不违规”的教训。
- 明确分配民事责任——法规和法律明确规定，受泄露信息影响的各方有权提起损害赔偿诉讼，可能采取集体诉讼的形式。
- 加强监管审查——有时，违规行为意味着监管机构将在未来几年内格外严厉地审查你的组织，以确保不再发生违规行为。由于需要监管机构批准变更，这种额外的关注通常会减慢内部流程，有时会迫使内部流程发生变化，以在事件解决后很好地安抚监管机构。

### 第 16.3 节：定期重新处理的驱动因素

重新处理是一个遥测过程，由于某种原因，你必须重写所有遥测数据。这个过程可以由以下几个因素驱动：

- 你的遥测存储系统更改了其格式，需要你重新处理以更新系统中已有遥测的存储格式。
- 你的遥测存储系统更改了其备份（离线）格式，要求你重新处理以确保可以恢复你的备份（或离线存储）。
- 你的演示系统改变了对遥测数据格式的期望，要求你重新处理旧的遥测数据以符合新的期望。

### 第 16.4 节：为什么隔离遥测对你有帮助

第 16.4 节首先列出了一系列原则，解释了为什么隔离遥测最终可以减少有毒数据泄漏的影响。减少影响可以减少溢出物清理的麻烦。

- 当你需要处理泄漏时，将有可能包含有毒数据（例如 API 服务器事件）的遥测流与绝对不会包含有毒数据（例如网络硬件遥测）的流隔离开来，将为你节省金钱和时间。
- 如果你的生产系统处理有毒数据，那么将所有集中式日志记录放入单个系统中是一种明显的反模式，这可以最大化你的清理区域。
- 使用演示阶段系统中提供的访问控制列表 (ACL) 功能，将包含遥测数据的潜在有毒数据的访问权限限制为特别需要该访问权限的团队。该策略减少了泄漏的影响。
- 由于异常是包含有毒数据的遥测中风险最高的部分之一，因此需要花时间为异常设计单独的处理。此策略为你提供更好的实时编辑功能（在发布和运输阶段编辑有毒数据），允许你使用不同的 ACL 来审查异常，并允许你授予对应用程序日志记录的更广泛的访问权限。

### 第 16.4 节：避免误报有毒数据检测的提示

第 16.4 节最后提出了编写应用程序的建议，以避免在使用有毒数据检测器（例如 Amazon 和 Microsoft 提供的 PII 检测器）扫描遥测数据时出现误报检测：

- 避免使用随机 16 位整数。信用卡号码为 16 位数字。尽管每个 16 位整数都不是有效的信用卡号，但如果你随机生成足够多的这些整数，绝对概率会创建通过定义信用卡号有效格式的 Luhn 算法的数字。一百万只猴子敲击打字机最终可以产生莎士比亚，但随机数生成器可以更快地产生可行的信用卡号码。省去一些麻烦；将这些整数改为 15 或 17 位数字。更好的是，将它们设为十六进制并完全避免整数。
- 避免使用随机的 10 到 13 位整数。大多数带有国家/地区代码的电话号码都在此范围内（或带有区号的美国电话号码）。如果前几个数字最终与国家/地区代码匹配，这些整数可能看起来像电话号码，并被检测器标记为 PII。
- 避免使用随机的 9 位整数。这些整数与美国社会安全号码的长度相同。美国在科技行业的中心主义意味着 PII 检测器关心这一事实，即使你不在美国开展业务。至于信用卡，存在某种验证算法，并且随机数生成器的命中率足以令人烦恼。
- 发出帐号，而不是帐号名称。通常，帐户名称是电子邮件地址（或看起来像电子邮件地址的名称），因此会被检测器标记。最好在帐户表的主键是什么中发出遥测数据，因为这可能是一个数字。 （也许在另一个基数中进行以避免整数问题。）
- 将 IP 地址保留在你的网络、Web 服务器、API 网关和负载均衡器日志中，并将其排除在应用程序遥测之外。现在许多隐私制度都将 IP 地址视为 PII。将 IP 地址存储在某处，并提供一种在管理门户中轻松查找它们的方法，但将实际地址排除在遥测之外。如果你仍然需要 IP 地址跟踪，请改用哈希值或其他代理值。
- 避免通过应用程序遥测发送地理 IP 数据 (GeoIP)。如果给出 IP 地址，一些图书馆和服务将返回城市、州、国家和大陆。付费服务进一步缩小了 GeoIP 分辨率，将 IP 地址与社区甚至特定建筑物隔离。因此，隐私监管机构将此类 GeoIP 数据视为私有数据。这些服务在欺诈和恶意使用调查以及遵守政府对其他国家/地区强制实施的制裁方面非常有用，但将这些数据放在每个应用程序遥测中会不必要地使你的组织面临法律风险。将 GeoIP 数据保存到你的 Web 服务器和网络遥测中。

## B.5 法律主题

第 18 章在本书中很独特，因为它讨论了技术书籍中很少涉及的内容：如何与律师合作。本章有两个列表需要重复。

### 第 18.2 节：评估处理合法保留指令的遥测系统时要提出的问题

响应潜在法律问题的第一步是，你组织的法律部门对可能与正在酝酿的任何法律问题相关的记录进行合法保留。此保留可以包括你的遥测系统。如果你已经考虑过在此过程中会发生什么，你会对整个过程感到更加满意。在评估遥测设计时，你应该问自己以下问题：

- 如果我们被要求保存遥测数据的一部分，是保存该部分更容易还是保存当时的所有内容更容易？在考虑问题之前了解存储部分数据集还是完整数据集更容易，这样可以节省每个人的精力。
- 我们如何保护所保存的数据免遭例行编辑和重新处理？你需要能够防止合法保留数据发生更改。如果你当前的系统使该任务变得困难，请花时间缓解它。
- 我们将如何保护我们的未编辑/未重新处理的合法持有数据免受我们的普通客户的侵害？如果你需要执行编辑，则需要保持未编辑的遥测数据仅对律师可见。如果法律问题进展到发现阶段，律师将进行任何编辑。此外，如果你需要为所保存的数据运行第二组系统（需要免除组织补丁策略的系统），你可以将对潜在易受攻击的系统的访问权限隔离给所涉及的律师和最少数量的遥测系统操作员需要保持系统运行。
- 我们如何允许我们的律师审查我们保存的数据？除非保留令适用于所有内容，否则你所在组织的律师很有可能希望确保你保存正确的内容。让他们。无论如何，当 ECA 启动时，你都需要进行此检查（第 18.1 节）。
- 如果合法保留要求我们保留仍在生成的遥测数据，那么我们需要做出哪些更改来确保保留此类遥测数据？并非所有请求都只是为了获取历史信息；有些保留可能要求你保留当前生成的部分或全部遥测数据。如果你被要求这样做，那么了解你需要进行哪些更改来支持保留实时遥测将使编写更改变得更加容易。
- 在我们当前的软件版本中是否可以查看最古老的遥测数据？如果保留策略的一部分涉及将遥测数据离线存储一段时间，则你需要尽早了解最旧的遥测数据是否可以恢复到当前系统中，或者是否需要第二个系统进行恢复。设置第二个系统需要资源，因此提前知道需要请求多少资源可以节省每个人的时间和精力。
- 如果我们必须在保留期内升级存储软件，我们是否需要避免升级合法保留系统？随着诉讼的进展，保留订单可能会持续数年。了解升级保留订单中涉及的资源是否安全将有助于你遵守所遵守的任何法规。如果升级不安全，尽早了解可以让你在补丁和漏洞管理策略中专门针对这种边缘情况设置例外。

### 第 18.4 节：如何与律师合作

如果你以前从未与律师合作过，那么与律师合作可能会很可怕！请记住，律师是不同类型的技术人员。更好的是，你可以让你所在组织的律师为你与特别可怕的律师交谈。如果你需要与律师合作，请记住以下几点：

- 你自己组织的律师比你更擅长讲律师。如果你不确定审判团队在谈论什么，请要求你所在组织的律师进行澄清。 （顺便说一句，即使这些事件不会影响你，这条提示也适用于解释事件中发生的情况。）与外部法律顾问不同，你所在组织的律师可能是拿薪水的，而不是按分钟计费。
- 成本管理是贵组织律师的主要职责。外部顾问需要花钱；他们对每次互动收费，并在他们关注你的案件时随时找到计费方式。如果你认为请求过于宽泛（即可能过于昂贵），请向你所在组织的律师寻求建议。他们的职责就是提供建议。
- 外部审判律师通常会配备技术专家。使用它们。如果你不清楚请求的含义，即使在询问了自己的律师之后，审判律师的技术人员也可能可以将请求从律师翻译为工程师。他们的收费率也远低于实际律师的收费率。
- 如果你必须推迟技术细节，请与技术专家一起进行。外部团队的专家比你更熟悉发现过程，因此他们对于确定可行的方案非常有价值。他们也不太可能成为“问明月”类型。